From 0b62bc25cffab770d00170e43f6368249ff556c6 Mon Sep 17 00:00:00 2001
From: Blondel MONDESIR <blondel.md@gmail.com>
Date: Mon, 10 Nov 2025 11:19:17 +0100
Subject: [PATCH] WIP: Fix hardcoded URLs to support subpath deployment

---
 static/brands/rapidpro/less/style.less  |  2 +-
 static/js/frame.js                      |  8 ++++----
 temba/notifications/types/builtin.py    |  4 ++--
 temba/utils/templatetags/url_tags.py    | 13 +++++++++++++
 templates/allauth/layouts/entrance.html |  2 +-
 templates/frame.html                    |  5 ++++-
 templates/orgs/org_join.html            |  2 +-
 templates/public/public_frame.html      |  2 +-
 templates/public/public_index.html      |  2 +-
 temba/urls.py                           | 21 +++++++++++++++++----
 10 files changed, 49 insertions(+), 12 deletions(-)
 create mode 100644 temba/utils/templatetags/url_tags.py

diff --git a/static/brands/rapidpro/less/style.less b/static/brands/rapidpro/less/style.less
index 62b5e7b3f..428839903 100644
--- a/static/brands/rapidpro/less/style.less
+++ b/static/brands/rapidpro/less/style.less
@@ -1,6 +1,6 @@
 #splash {
   margin-top: -30px;
-  background: url('/sitestatic/brands/rapidpro/splash.jpg') 0px 0px !important;
+  background: url('../splash.jpg') 0px 0px !important;
   background-size: cover !important;
   width: 100%;
   height: 0px;
diff --git a/static/js/frame.js b/static/js/frame.js
index 545e9a421..56b1fad47 100644
--- a/static/js/frame.js
+++ b/static/js/frame.js
@@ -1,6 +1,6 @@
 var pendingRequests = [];
 
-const OMIT_ORG_URLS = ['/staff/', '/org/choose/'];
+const OMIT_ORG_URLS = [window.URLS.staff_org_list, window.URLS.orgs_org_choose];
 
 function onSpload(fn) {
   var container = document.querySelector('.spa-container');
@@ -473,7 +473,7 @@ function showModax(header, endpoint, modaxOptions) {
 }
 
 function handleWorkspaceChanged(orgId) {
-  posterize(`/org/choose/?organization=${orgId}`);
+  posterize(`${window.URLS.orgs_org_choose}?organization=${orgId}`);
 }
 
 document.addEventListener('temba-redirected', function (event) {
@@ -525,7 +525,7 @@ document.addEventListener('DOMContentLoaded', function () {
         evt.stopPropagation();
         evt.preventDefault();
 
-        if (url.indexOf('/org/service') > -1) {
+        if (url.indexOf(window.URLS.staff_org_service) > -1) {
           formEle.submit();
         } else {
           spaPost(url, { postData: new FormData(formEle) });
@@ -591,7 +591,7 @@ function formatContact(item) {
 function handleNewWorkspaceClicked(evt) {
   var modal = getModax();
   modal.header = 'New Workspace';
-  modal.setAttribute('endpoint', '/org/create');
+  modal.setAttribute('endpoint', window.URLS.orgs_org_create);
   modal.open = true;
 
   evt.preventDefault();
diff --git a/temba/notifications/types/builtin.py b/temba/notifications/types/builtin.py
index 680b0da66..3a28ccf4b 100644
--- a/temba/notifications/types/builtin.py
+++ b/temba/notifications/types/builtin.py
@@ -105,7 +105,7 @@ class TicketsOpenedNotificationType(NotificationType):
     slug = "tickets:opened"
 
     def get_target_url(self, notification) -> str:
-        return "/ticket/unassigned/"
+        return reverse("tickets.ticket_folder", kwargs={"folder": "unassigned", "status": "open"})
 
 
 class TicketActivityNotificationType(NotificationType):
@@ -116,7 +116,7 @@ class TicketActivityNotificationType(NotificationType):
     slug = "tickets:activity"
 
     def get_target_url(self, notification) -> str:
-        return "/ticket/mine/"
+        return reverse("tickets.ticket_folder", kwargs={"folder": "mine", "status": "open"})
 
 
 class UserEmailNotificationType(NotificationType):
diff --git a/temba/utils/templatetags/url_tags.py b/temba/utils/templatetags/url_tags.py
new file mode 100644
index 000000000..8f65fcfb3
--- /dev/null
+++ b/temba/utils/templatetags/url_tags.py
@@ -0,0 +1,13 @@
+from django import template
+from django.urls import reverse
+
+register = template.Library()
+
+@register.simple_tag
+def get_urls():
+    return {
+        "staff_org_list": reverse("staff.org_list"),
+        "orgs_org_choose": reverse("orgs.org_choose"),
+        "staff_org_service": reverse("staff.org_service"),
+        "orgs_org_create": reverse("orgs.org_create"),
+    }
diff --git a/templates/allauth/layouts/entrance.html b/templates/allauth/layouts/entrance.html
index faf642dc0..0286c030b 100644
--- a/templates/allauth/layouts/entrance.html
+++ b/templates/allauth/layouts/entrance.html
@@ -33,7 +33,7 @@
       margin-bottom: 0;
     }
 
-    form[action="/accounts/login/"] button[type="submit"],
+    form[action="{% url 'account_login' %}"] button[type="submit"],
     form[action="/accounts/2fa/authenticate/"] button[type="submit"] {
       display: block;
       width: 100%;
diff --git a/templates/frame.html b/templates/frame.html
index c6e4ea2c8..f18494f03 100644
--- a/templates/frame.html
+++ b/templates/frame.html
@@ -1,5 +1,5 @@
 <!DOCTYPE HTML>
-{% load humanize i18n smartmin sms compress static %}
+{% load humanize i18n smartmin sms compress static url_tags %}
 
 {% block html-tag %}
   <html lang="{{ LANGUAGE_CODE }}">
@@ -32,6 +32,9 @@
     {% compress js %}
       <script src="{{ STATIC_URL }}js/utils.js"></script>
     {% endcompress %}
+    <script>
+      window.URLS = {% get_urls %};
+    </script>
     <script type="text/javascript">
       function isMobile() {
         return window.innerWidth < 600;
diff --git a/templates/orgs/org_join.html b/templates/orgs/org_join.html
index 3b1882e50..28e435da1 100644
--- a/templates/orgs/org_join.html
+++ b/templates/orgs/org_join.html
@@ -16,7 +16,7 @@
     {% endblocktrans %}
   </div>
   <form method="post"
-        action="/accounts/login/?next={% url 'orgs.org_join_accept' invitation.secret %}"
+        action="{% url 'account_login' %}?next={% url 'orgs.org_join_accept' invitation.secret %}"
         class="mt-6"
         id="login-form">
     <fieldset>
diff --git a/templates/public/public_frame.html b/templates/public/public_frame.html
index aaa748c72..f86951bcb 100644
--- a/templates/public/public_frame.html
+++ b/templates/public/public_frame.html
@@ -6,7 +6,7 @@
       <div class="flex-grow"></div>
       <div class="w-128">
         <div class="mb-6 w-64 mt-12">
-          <a href="/">
+          <a href="{% url 'public.public_index' %}">
             <img src="{{ STATIC_URL }}images/logo-dark.svg">
           </a>
         </div>
diff --git a/templates/public/public_index.html b/templates/public/public_index.html
index a5df1551b..7760338fd 100644
--- a/templates/public/public_index.html
+++ b/templates/public/public_index.html
@@ -4,7 +4,7 @@
   <div class="text-xl font-normal mb-2 mt-6">Getting Started</div>
   <div class="mb-2">
     To get started, visit the  <a href="http://rapidpro.github.io/rapidpro/docs/development/">developer documentation</a>.
-    Once you've created an account in your development database, you can login <a href="/accounts/login">here</a>.
+    Once you've created an account in your development database, you can login <a href="{% url 'account_login' %}">here</a>.
   </div>
   <div class="mb-2">
     If you still have questions, please search the history on the <a href="https://groups.google.com/g/rapidpro-dev">developer list</a> to see if your question has been asked before.
diff --git a/temba/urls.py b/temba/urls.py
index e5a0f20ce..082f2b72a 100644
--- a/temba/urls.py
+++ b/temba/urls.py
@@ -7,12 +7,12 @@ from django.views.i18n import JavaScriptCatalog
 # javascript translation packages
 js_info_dict = {"packages": ()}  # this is empty due to the fact that all translation are in one folder
 
-urlpatterns = []
+_urlpatterns = []
 # import any additional urls
 for app in settings.APP_URLS:  # pragma: needs cover
-    urlpatterns.append(re_path(r"^", include(app)))
+    _urlpatterns.append(re_path(r"^", include(app)))
 
-urlpatterns += [
+_urlpatterns += [
     re_path(r"^", include("temba.ai.urls")),
     re_path(r"^", include("temba.airtime.urls")),
     re_path(r"^", include("temba.api.urls")),
@@ -41,5 +41,10 @@ urlpatterns += [
     re_path("accounts/", include("allauth.urls")),
 ]
 
+if getattr(settings, "RAPIDPRO_URL", None) and settings.RAPIDPRO_URL != "/":
+    urlpatterns = [re_path(r"^{}/".format(settings.RAPIDPRO_URL.strip('/')), include(_urlpatterns))]
+else:
+    urlpatterns = _urlpatterns
+
 if settings.DEBUG:
     urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
-- 
2.43.0

