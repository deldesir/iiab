---
# This file will contain all the installation tasks for RapidPro.

- name: Drop RapidPro database if requested
  block:
    - name: Drop RapidPro PostgreSQL database
      postgresql_db:
        name: "{{ rapidpro_db_name }}"
        state: absent
      become: yes
      become_user: postgres

    - name: Drop RapidPro PostgreSQL user
      postgresql_user:
        name: "{{ rapidpro_db_user }}"
        state: absent
      become: yes
      become_user: postgres
  when: rapidpro_force_drop_db | default(false)

- name: Uninstall RapidPro if reinstalling
  block:
    - name: Get poetry environment path
      shell: |
        export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
        poetry env info --path
      args:
        chdir: "{{ rapidpro_dir }}"
      register: poetry_env
      become: yes
      become_user: "{{ iiab_admin_user }}"
      changed_when: false
      failed_when: false

    - name: Remove poetry virtualenv
      file:
        path: "{{ poetry_env.stdout }}"
        state: absent
      become: yes
      become_user: "{{ iiab_admin_user }}"
      when: poetry_env.stdout != ""

    - name: Remove RapidPro directory
      file:
        path: "{{ rapidpro_dir }}"
        state: absent
      become: yes
  when: reinstall is defined and reinstall



- name: Install essential build tools and libraries
  apt:
    name:
      - git
      - build-essential
      - libpq-dev
      - python3-dev
      - libgdal-dev
      - ffmpeg
    state: present
  become: yes

- name: Install Valkey/Redis
  block:
    - name: Try installing valkey-server
      apt:
        name: valkey-server
        state: present
      become: yes
  rescue:
    - name: Fallback to redis-server
      apt:
        name: redis-server
        state: present
      become: yes

- name: Install Python build dependencies
  apt:
    name:
      - make
      - libssl-dev
      - zlib1g-dev
      - libbz2-dev
      - libreadline-dev
      - libsqlite3-dev
      - wget
      - curl
      - llvm
      - libncurses5-dev
      - libncursesw5-dev
      - xz-utils
      - tk-dev
      - libffi-dev
      - liblzma-dev
      - python3-openssl
    state: present
  become: yes

- name: "Set 'nodejs_install: True' and 'nodejs_enabled: True'"
  set_fact:
    nodejs_install: True
    nodejs_enabled: True

- name: Include nodejs role
  include_role:
    name: nodejs

- name: Check if rapidpro directory exists
  stat:
    path: "{{ rapidpro_dir }}"
  register: rapidpro_dir_stat

- name: Clone RapidPro repository
  git:
    repo: 'https://github.com/nyaruka/rapidpro.git'
    dest: "{{ rapidpro_dir }}"
  become: yes
  when: not rapidpro_dir_stat.stat.exists

- name: Set ownership of project directory
  file:
    path: "{{ rapidpro_dir }}"
    state: directory
    owner: "{{ iiab_admin_user }}"
    group: "www-data"
    mode: "0770"
    recurse: yes
  become: yes

- name: Clean RapidPro repository
  shell: |
    git reset --hard
    git clean -fdx
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  become_user: "{{ iiab_admin_user }}"

- name: Check if patch can be applied
  command: git apply --check {{ role_path }}/files/0001-Fix-hardcoded-URLs-and-subpath.patch
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  become_user: "{{ iiab_admin_user }}"
  register: patch_check
  ignore_errors: yes

- name: Apply patch for subpath deployment
  command: git apply {{ role_path }}/files/0001-Fix-hardcoded-URLs-and-subpath.patch
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  become_user: "{{ iiab_admin_user }}"
  when: patch_check.rc == 0

- name: "Allow Python version in pyproject.toml"
  replace:
    path: "{{ rapidpro_dir }}/pyproject.toml"
    regexp: 'requires-python = ">=3.12,<3.13"'
    replace: 'requires-python = ">=3.12,<3.{{ (ansible_python_version.split(''.'')[1] | int) + 1 }}"'
  become: yes




- name: Install Poetry
  shell: |
    curl -sSL https://install.python-poetry.org | python3 -
  args:
    creates: "/home/{{ iiab_admin_user }}/.local/bin/poetry"
  become: yes
  become_user: "{{ iiab_admin_user }}"

- name: Install Python dependencies with Poetry
  shell: |
    export PATH="/home/{{ iiab_admin_user }}/.local/bin:$PATH"
    poetry env remove --all
    poetry env use $(which python3)
    poetry lock
    poetry install
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes
  become_user: "{{ iiab_admin_user }}"

- name: Install yarn
  npm:
    name: yarn
    global: yes
  become: yes

- name: Install JavaScript dependencies
  yarn:
    path: "{{ rapidpro_dir }}"
  become: yes

- name: Install global JS tools (less)
  yarn:
    name: less
    global: yes
  become: yes

- name: Build CSS assets
  shell: |
    yarn tw-build
  args:
    chdir: "{{ rapidpro_dir }}"
  become: yes

- name: "Set mailroom and courier architecture"
  set_fact:
    rapidpro_go_arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' }}"

- name: Get latest Mailroom version
  uri:
    url: "https://api.github.com/repos/nyaruka/mailroom/releases/latest"
    body_format: json
  register: mailroom_latest_release

- name: Set Mailroom version fact
  set_fact:
    mailroom_version: "{{ mailroom_latest_release.json.tag_name | regex_replace('^v', '') }}"

- name: Download Mailroom
  get_url:
    url: "https://github.com/nyaruka/mailroom/releases/download/v{{ mailroom_version }}/mailroom_{{ mailroom_version }}_linux_{{ rapidpro_go_arch }}.tar.gz"
    dest: /tmp/mailroom.tar.gz
  become: yes

- name: Create temp directory for mailroom
  tempfile:
    state: directory
  register: mailroom_tempdir

- name: Install Mailroom
  shell: |
    tar -xzf /tmp/mailroom.tar.gz -C {{ mailroom_tempdir.path }}
  become: yes

- name: Move mailroom executable
  command: mv {{ mailroom_tempdir.path }}/mailroom /usr/local/bin/mailroom
  become: yes
  args:
    creates: /usr/local/bin/mailroom

- name: Clean up mailroom temp directory
  file:
    path: "{{ mailroom_tempdir.path }}"
    state: absent

- name: Get latest Courier version
  uri:
    url: "https://api.github.com/repos/nyaruka/courier/releases/latest"
    body_format: json
  register: courier_latest_release

- name: Set Courier version fact
  set_fact:
    courier_version: "{{ courier_latest_release.json.tag_name | regex_replace('^v', '') }}"

- name: Download Courier
  get_url:
    url: "https://github.com/nyaruka/courier/releases/download/v{{ courier_version }}/courier_{{ courier_version }}_linux_{{ rapidpro_go_arch }}.tar.gz"
    dest: /tmp/courier.tar.gz
  become: yes

- name: Create temp directory for courier
  tempfile:
    state: directory
  register: courier_tempdir

- name: Install Courier
  shell: |
    tar -xzf /tmp/courier.tar.gz -C {{ courier_tempdir.path }}
  become: yes

- name: Move courier executable
  command: mv {{ courier_tempdir.path }}/courier /usr/local/bin/courier
  become: yes
  args:
    creates: /usr/local/bin/courier

- name: Clean up courier temp directory
  file:
    path: "{{ courier_tempdir.path }}"
    state: absent
