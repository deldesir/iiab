#!/bin/sh
# /usr/local/pdsm/services-available/mailroom
# PDSM service wrapper for RapidPro Mailroom
# Refactored for Android/PRoot persistence

PDSM_COMMON="/usr/local/pdsm/lib/pdsm-common.sh"
[ -r "$PDSM_COMMON" ] && . "$PDSM_COMMON"

SERVICE_NAME="mailroom"
PIDFILE="/run/rapidpro/mailroom.pid"
LOGFILE="/tmp/mailroom.log"

# Connection Strings (Android/PRoot optimized)
# - Postgres: Use Unix Socket (URL encoded)
# - Valkey: Use TCP (Go driver requirement) and valkey:// scheme
export MAILROOM_DB="postgres://{{ rapidpro_db_user }}:{{ rapidpro_db_pass }}@localhost/{{ rapidpro_db_name }}?host=/var/run/postgresql&sslmode=disable"
export MAILROOM_VALKEY="valkey://127.0.0.1:6379/0"
export MAILROOM_SESSION_STORAGE="db"
export MAILROOM_SPOOL_DIR="{{ rapidpro_dir }}/spool/mailroom"
export AWS_ACCESS_KEY_ID="dummy"
export AWS_SECRET_ACCESS_KEY="dummy"
export AWS_REGION="us-east-1"
# DynamoDB on localhost TCP
export MAILROOM_DYNAMO_ENDPOINT="http://127.0.0.1:4567"
export MAILROOM_S3_ENDPOINT="http://localhost:1"
export MAILROOM_ELASTIC=""

mkdir -p /run/rapidpro
mkdir -p /var/log/rapidpro
mkdir -p "$MAILROOM_SPOOL_DIR"
chown {{ iiab_admin_user }}:{{ iiab_admin_user }} "$MAILROOM_SPOOL_DIR" 2>/dev/null || true
chown {{ iiab_admin_user }}:{{ iiab_admin_user }} /var/log/rapidpro 2>/dev/null || true

running() {
  # Check if the process exists (pgrep returns 0 if found)
  # Removing -u check as PRoot UID mapping can be flaky for pgrep
  pgrep -f "/usr/local/bin/mailroom" >/dev/null
}

start() {
  if running; then
    echo "[pdsm:$SERVICE_NAME] already running"
    return 0
  fi

  echo "[pdsm:$SERVICE_NAME] starting..."
  
  # Proactive Cleanup
  pkill -u {{ iiab_admin_user }} -f "/usr/local/bin/mailroom" >/dev/null 2>&1 || true

  # Prepare the command string.
  # Note: Variables inside standard single quotes '...' are literal. 
  # We construct a string with single quotes around values to protect them in the shell.
  CMD="export MAILROOM_DB='$MAILROOM_DB'; \
export MAILROOM_VALKEY='$MAILROOM_VALKEY'; \
export MAILROOM_SESSION_STORAGE='db'; \
export MAILROOM_SPOOL_DIR='$MAILROOM_SPOOL_DIR'; \
export AWS_ACCESS_KEY_ID='dummy'; \
export AWS_SECRET_ACCESS_KEY='dummy'; \
export AWS_REGION='us-east-1'; \
export MAILROOM_DYNAMO_ENDPOINT='http://127.0.0.1:4567'; \
export MAILROOM_S3_ENDPOINT='http://localhost:1'; \
export MAILROOM_ELASTIC=''; \
/usr/local/bin/mailroom >>\"$LOGFILE\" 2>&1"

  # Execute utilizing the specific screen+su pattern for PRoot persistence.
  # We run 'su - iiab-admin -c ...' inside screen.
  screen -dmS "$SERVICE_NAME" su - {{ iiab_admin_user }} -c "$CMD"

  for i in $(seq 1 10); do
    if running; then
      echo "[pdsm:$SERVICE_NAME] started"
      return 0
    fi
    sleep 1
  done

  echo "[pdsm:$SERVICE_NAME] failed to start" >&2
  # Cleanup
  screen -X -S "$SERVICE_NAME" quit >/dev/null 2>&1 || true
  return 1
}

stop() {
  if ! running; then
    echo "[pdsm:$SERVICE_NAME] already stopped"
    return 0
  fi

  echo "[pdsm:$SERVICE_NAME] stopping..."
  
  pid=$(pgrep -f "/usr/local/bin/mailroom")
  if [ -n "$pid" ]; then
    kill "$pid" 2>/dev/null || true
    for i in $(seq 1 5); do
      if ! running; then break; fi
      sleep 1
    done
    kill -9 "$pid" 2>/dev/null || true
  fi
  
  # Clean up screen session
  screen -X -S "$SERVICE_NAME" quit >/dev/null 2>&1 || true
  
  rm -f "$PIDFILE"
  echo "[pdsm:$SERVICE_NAME] stopped"
  return 0
}

status() {
  if running; then
    echo "[pdsm:$SERVICE_NAME] running"
    return 0
  fi
  echo "[pdsm:$SERVICE_NAME] not running"
  return 3
}

restart() {
   stop
   sleep 1
   start
}

case "$1" in
  start|stop|restart|status) "$1" ;;
  *) echo "Usage: $0 {start|stop|restart|status}" >&2; exit 1 ;;
esac
